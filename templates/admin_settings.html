<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{{ url_for('static', filename='fontawesome/all.min.css') }}">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;500&amp;display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='framework.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_dashboard.css') }}">
</head>

<body>
    <div class="page d-flex">
        <div class="sidebar bg-white p-20 p-relative">
            <ul>
                <li>
                    <a href="{{ url_for('admin_dashboard') }}" class="d-flex align-items-center font-14 p-10 rad-6 color-black">
                        <i class="fa-solid fa-house"></i>
                        <span>Dashboard</span>
                    </a>
                </li>

                <li>
                    <a href="{{ url_for('admin_list') }}" class="d-flex align-items-center font-14 p-10 rad-6 color-black">
                        <i class="fa-solid fa-people-group"></i>
                        <span>Activity</span>
                    </a>
                </li>
               
                <li>
                    <a href="{{ url_for('admin_results')}}" class="d-flex align-items-center font-14 p-10 rad-6 color-black">
                        <i class="fa-solid fa-square-poll-vertical"></i>
                        <span>Results</span>
                    </a>
                </li>
    
                <li>
                    <a href="{{ url_for('admin_settings') }}" class="active d-flex align-items-center font-14 p-10 rad-6 color-black">
                        <i class="fa fa-gears"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="content w-full">
               <!-- Start Header -->
               <div class="header bg-white p-14 between-flex" style="border-radius: 20px;padding: 10px;">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='images/STC_logo.png') }}" alt="Logo 2" class="logo">
                </div>
                <div class="search-container">
                    <input id="searchInput" class="search-box" type="search" placeholder="Search ">
                    <i class="fas fa-search search-icon"></i>
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div class="user d-flex align-items-center">
                                

                    <!-- User Info -->
                    <div class="user-info d-flex align-items-center">
                        <div class="user-img" id="userDropdownToggle">
                            <img src="{{ admin.profile_image}}"  alt="User">
                        </div>
                    </div>
                    
                    <!-- Dropdown Menu -->
                    <div id="userDropdown" class="dropdown-menu">
                        <ul>
                            <li>
                                <a href="{{ url_for('admin_profile') }}" class="d-flex align-items-center font-14 p-10 rad-6 color-black">
                                    <i class="fas fa-user fa-fw"></i>
                                    <span>Profile</span>
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('admin_logout') }}" class="d-flex align-items-center font-14 p-10 rad-6 color-black">
                                    <i class="fas fa-sign-out-alt fa-fw"></i>
                                    <span>Logout</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
            <!-- End Header -->

            <h1 class="p-relative">Settings</h1>

            <div class="settings-container bg-white p-40">
                <div class="setting-info m-20" style="display: flex; flex-direction: row; gap: 10px;">

                    <!-- Start Theme Control Section -->
                    <div class="theme-control mt-20">
                        <h2 class="mt-0 mb-5">Theme Control</h2>
                        <span class="mt-0 mb-20 font-15 color-grey d-block">Choose Theme Mode</span>
                    
                        <label>
                            <input type="radio" name="themeOption" value="light" class="theme-radio"> Light
                        </label><br>
                        <label>
                            <input type="radio" name="themeOption" value="dark" class="theme-radio"> Dark
                        </label><br>
                        <label>
                            <input type="radio" name="themeOption" value="auto" class="theme-radio"> Auto
                        </label>
                    </div>

                    <!-- Start Security Info Section -->
                    <div class="security-info mt-20">
                        <h2 class="mt-0 mb-5">Security Info</h2>
                        <span class="mt-0 mb-20 font-15 color-grey d-block">Security Information About Your Account</span>
                        <div class="between-flex m-0 pb-20">
                            <div>
                                <p class="mb-5 mt-0">Password</p>
                                <span class="font-13 color-grey mr-10">
                                    Last Changed: {{ admin.password_updated_at.strftime('%m/%d/%Y') if admin.password_updated_at else 'N/A' }}
                                </span>
                            </div>
                            <button id="changePasswordBtn" class="btn bg-blue color-white" style="cursor: pointer; border:0;">Change</button>
                        </div>

                        <!-- Login Activity Section -->
                        <div class="login-activity mt-20">
                            <p class="mb-10">Recent Login Activity</p>
                            <div class="scrollable-activity m-0">
                                <ul class="font-13 color-grey">
                                    {% for login in recent_logins[:1] %}
                                        <li class="login-item extra-login">
                                            - {{ recent_logins[0].timestamp.strftime('%b %d, %Y %I:%M %p') }}
                                        </li>
                                    {% else %}
                                        <li>No login activity found.</li>
                                    {% endfor %}
                                </ul>
                                <button id="showAllLoginsBtn" class="btn bg-blue color-white" style="cursor: pointer; border:0;">Show All Activity</button>
                            </div>
                        </div>
                                                
                        <!-- Modal for showing all login activity -->
                        <div id="loginActivityModal" class="modal">
                            <div class="modal-content">
                                <span id="closeLoginModal" class="close">&times;</span>
                                    <h3 style="margin-left:20px;">All Login Activity</h3>
                                    <div class="login_border mb-20"></div>
                                    <ul class="font-14 color-grey">
                                        {% for login in all_logins %}
                                            <li class="login pb-8">
                                                {{ login.timestamp.strftime('%b %d, %Y %I:%M %p') }}
                                            </li>
                                        {% else %}
                                            <li>No login activity found.</li>
                                        {% endfor %}
                                    </ul>
                            </div>
                        </div>
                    </div>               
                    <!-- End Security Info -->
                
                    <!-- Password Change Modal -->
                    <div id="passwordChangeModal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <span class="close-btn" id="closeModal">&times;</span>
                            <h2>Change Password</h2>
                            <form id="changePasswordForm" class="mb-60 p-10">
                                <div class="form-group">
                                    <label>Old Password</label>
                                    <input type="password" name="old_password" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>New Password</label>
                                    <input type="password" name="new_password" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Confirm New Password</label>
                                    <input type="password" name="confirm_password" class="form-control" required>
                                </div>
                                <div class="button-group">
                                    <button type="submit" class="btn bg-blue color-white">Update Password</button>
                                    <button type="button" id="cancelChangeBtn" class="btn bg-grey color-black">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- End Password Change Modal -->
                </div>
            </div>
            <!-- End Main Settings Container -->

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const changePasswordBtn = document.getElementById("changePasswordBtn");
                const passwordChangeModal = document.getElementById("passwordChangeModal");
                const closeModal = document.getElementById("closeModal");
                const cancelChangeBtn = document.getElementById("cancelChangeBtn");
            
                // Ensure modal is hidden on page load
                passwordChangeModal.style.display = "none";
            
                // Show modal when clicking "Change Password" button
                changePasswordBtn.addEventListener("click", function () {
                    passwordChangeModal.style.display = "flex"; // Only show when button is clicked
                });
            
                // Hide modal when clicking "Cancel" or close button
                function closeModalFunc() {
                    passwordChangeModal.style.display = "none";
                }
            
                closeModal.addEventListener("click", closeModalFunc);
                cancelChangeBtn.addEventListener("click", closeModalFunc);
            
                // Hide modal when clicking outside the modal-content
                window.addEventListener("click", function (event) {
                    if (event.target === passwordChangeModal) {
                        closeModalFunc();
                    }
                });
            
                // Handle password change via AJAX
                document.getElementById("changePasswordForm").addEventListener("submit", async function (event) {
                    event.preventDefault();
            
                    let formData = new FormData(this);
            
                    try {
                        let response = await fetch("{{ url_for('change_password_ajax') }}", {
                            method: "POST",
                            body: formData,
                            credentials: 'include'
                        });
            
                        let result = await response.json();
            
                        if (result.success) {
                            alert("Password updated successfully!");
                            closeModalFunc();
                        } else {
                            alert("Error: " + result.message);
                        }
                    } catch (error) {
                        console.error("Error updating password:", error);
                    }
                });
            });
        </script>

        <script>
            const themeRadios = document.querySelectorAll('.theme-radio');
            const settingsContainer = document.querySelector('.settings-container');

            function applyTheme(theme) {
                document.body.classList.remove('dark-mode');
                settingsContainer.classList.remove('dark-mode');

                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    settingsContainer.classList.add('dark-mode');
                } else if (theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.body.classList.add('dark-mode');
                        settingsContainer.classList.add('dark-mode');
                    }
                }
            }

            // Set the selected radio button
            function updateThemeSelection(selectedValue) {
                themeRadios.forEach(rb => {
                    rb.checked = (rb.value === selectedValue);
                });
            }

            // On page load, apply saved theme
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            updateThemeSelection(savedTheme);

            // Listen for changes
            themeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.checked) {
                        const selectedTheme = radio.value;
                        localStorage.setItem('theme', selectedTheme);
                        applyTheme(selectedTheme);
                    }
                });
            });

            // Reapply auto theme on system change
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (localStorage.getItem('theme') === 'auto') {
                    applyTheme('auto');
                }
            });
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const modal = document.getElementById("loginActivityModal");
                const btn = document.getElementById("showAllLoginsBtn");
                const span = document.getElementById("closeLoginModal");
            
                btn.onclick = function () {
                    modal.style.display = "block";
                }
            
                span.onclick = function () {
                    modal.style.display = "none";
                }
            
                window.onclick = function (event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                }
            });
        </script>

        <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const userDropdownToggle = document.getElementById("userDropdownToggle");
                    const userDropdown = document.getElementById("userDropdown");
                
                    userDropdownToggle.addEventListener("click", function (event) {
                        event.stopPropagation();
                        userDropdown.classList.toggle("show");
                    });
                
                    // Close dropdown if clicking outside
                    document.addEventListener("click", function (event) {
                        if (!userDropdown.contains(event.target) && !userDropdownToggle.contains(event.target)) {
                            userDropdown.classList.remove("show");
                        }
                    });
                });
            </script>
                           <script>
                            document.getElementById("searchInput").addEventListener("input", async function () {
                            let query = this.value.trim();
                            let searchResults = document.getElementById("searchResults");
                
                            if (query === "") {
                                searchResults.style.display = "none";
                                return;
                            }
                
                            try {
                                let response = await fetch(`/search_participant?q=${encodeURIComponent(query)}`);
                                let data = await response.json();
                
                                searchResults.innerHTML = "";
                                if (data.length === 0) {
                                    searchResults.innerHTML = "<div>No results found</div>";
                                } else {
                                    data.forEach(participant => {
                                        let div = document.createElement("div");
                                        div.classList.add("search-result");
                                        div.innerHTML = `<strong>${participant.name}</strong> - ${participant.activity_name} <br>
                                                        <small>${participant.venue}, ${participant.school}</small>`;
                                        div.onclick = () => window.location.href = `/view-participant/${participant.id}`;
                                        searchResults.appendChild(div);
                                    });
                                }
                                searchResults.style.display = "block";
                            } catch (error) {
                                console.error("Error fetching search results:", error);
                            }
                        });
                
                        // Hide results when clicking outside
                        document.addEventListener("click", function (e) {
                            let searchBox = document.getElementById("searchInput");
                            let searchResults = document.getElementById("searchResults");
                
                            if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
                                searchResults.style.display = "none";
                            }
                        });  
                    </script>
                
            
</body>

</html>